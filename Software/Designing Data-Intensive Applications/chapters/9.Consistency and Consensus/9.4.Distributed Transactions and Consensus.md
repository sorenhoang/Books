# **Distributed Transactions and Consensus**

**Consensus** is a fundamental problem in distributed systems where the goal is to get several nodes to **agree** on a decision, such as electing a leader or committing a transaction. While it seems simple, reaching agreement is difficult in the face of network delays, crashes, and unreliable clocks.

---

### **Atomic Commit and Two-Phase Commit (2PC)**

**Atomic commit** ensures that a transaction spanning multiple nodes either **commits on all nodes** or **aborts on all nodes**.

*   **The Coordinator:** 2PC introduces a **transaction manager** (coordinator) that coordinates the commit process between participants.
*   **Phase 1 (Prepare):** The coordinator sends a **prepare request** to all participants. Each participant checks if it can commit (e.g., checking constraints and writing data to disk) and votes "yes" or "no". 
*   **The Promise:** By voting "yes," a participant **promises** to commit later and surrenders the right to abort unilaterally.
*   **Phase 2 (Commit/Abort):** If all participants vote "yes," the coordinator writes the decision to its disk (the **commit point**) and sends commit requests to all participants. If any vote "no" or time out, the coordinator sends an abort request.
*   **Coordinator Failure:** If the coordinator crashes after participants vote "yes" but before the final decision is sent, participants are left **in doubt** (uncertain). They cannot finish the transaction until the coordinator recovers, making 2PC a **blocking** protocol.

---

### **Distributed Transactions in Practice**

Distributed transactions are often categorized into two types:

1.  **Database-internal:** Transactions among nodes of a single partitioned/replicated database (e.g., VoltDB).
2.  **Heterogeneous:** Transactions across different technologies, such as two different database brands or a database and a **message broker**.

*   **XA Transactions:** The **eXtended Architecture** (XA) is a standard for 2PC across heterogeneous technologies, widely supported by relational databases and message brokers.
*   **The Cost:** Distributed transactions can **amplify failures** because the transaction must abort if any single participant or network link is broken. They also incur heavy performance penalties due to additional **fsyncs** and network round-trips.

---

### **Fault-Tolerant Consensus**

Formal consensus requires four properties to be satisfied: **Uniform agreement** (no two nodes decide differently), **Integrity** (no node decides twice), **Validity** (decided value must have been proposed), and **Termination** (every non-crashing node eventually decides).

*   **Relationship to Total Order Broadcast:** Total order broadcast is equivalent to repeated rounds of consensus; nodes agree on a fixed **sequence of messages** delivered in the same order to all replicas.
*   **Epoch Numbers:** Algorithms like **Paxos** and **Raft** use a monotonically increasing **epoch number** (or term) to ensure that if leaders conflict, the one with the higher epoch prevails.
*   **Majority Quorums:** Unlike 2PC, which requires every participant's vote, fault-tolerant consensus only requires a **majority** of nodes to reach a decision.

---

### **Membership and Coordination Services**

Tools like **ZooKeeper** and **etcd** are often used for "outsourcing" consensus tasks. They provide several critical features:

*   **Linearizable Atomic Operations:** Used for implementing distributed **locks and leases**.
*   **Total Ordering:** Providing **fencing tokens** to prevent a paused client from corrupting state.
*   **Failure Detection:** Using **ephemeral nodes** that disappear if a client’s session times out.
*   **Change Notifications:** Allowing clients to watch for changes in the cluster state.

***

**Analogy:** Two-phase commit is like a **wedding ceremony**. In Phase 1 (the vows), the minister asks each person individually if they take the other to be their spouse. By saying "I do," both individuals make a promise they cannot easily retract. If both say "I do," the minister performs the "commit point" by pronouncing them married. If one person faints (coordinator failure) immediately after the "I do's" but before the pronouncement, the couple is left "in-doubt"—they made the promise, but they don't know if the marriage is official until the minister wakes up to finish the ceremony.